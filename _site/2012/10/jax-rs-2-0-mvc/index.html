
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>JAX-RS 2.0 MVC</title>
    
    <meta name="author" content="Jan Algermissen">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Applying the Web To Enterprise IT</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>JAX-RS 2.0 MVC </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>08 October 2012</span>
    </div>
    <div class="content">
      <p>It is not unusual for services that expose a technical REST API to also need human-targeted UI for configuration, status checks or reporting.</p>

<p>What I have seen a couple of times is that developers naturally use some form of REST framework (for example JAX-RS) for the technical API but then make use of yet another API technology (for example Spring or JSF) for the human-targeted UI.</p>

<p>This not only increases the technology mix (something I personally strive to avoid as much as possible), but it also introduces a distinction between technical and human API that should not be made in my opinion. From an API point of view an HTTP interface that serves HTML and AJAX-targeted JSON is as much a REST-API as is one that serves XML or ‘technical’ JSON.</p>

<p>Instead, you should treat both as aspects of one and the same API. For one you will likely find resources in both API-’parts’ that serve representations of the same concepts (for example calendar events, shopping carts or contract information). Such repesentations of should be produced by one and the same resource. This reduces the amount of code and will help you, for example, to apply corresponding cacheability properties to both representations.</p>

<p>In addition, it will encourage you to treat the human-targeted API-parts with the same care as the technical ones. For example, you should allow introspection into them using some form of home document. Above all, you’ll never know in which ways clients re-use those HTML pages or snippets you serve.</p>

<p>Having said that, what might – besides just habits – be the reason that developers do not think ‘REST-API’ when they think ‘GUI’? Is it because many REST frameworks out there have very poor support for serving document-oriented representations such as HTML pages?</p>

<p>While some JAX-RS implementations have proprietary support for templating, the new JAX-RS 2.0 filter API lets you roll your own with a couple of lines of code.</p>

<p>Instead of the ‘Web-container-only’-setup I used in the last blog I would like full Java EE6 support this time. Fortunately, Arun Gupta has provided an example of how get JAX-RS 2.0 to work in a Java EE 6 container.</p>

<p>First I created a project based on the archetype Arun uses:</p>

<pre><code>mvn archetype:generate \
   -DarchetypeGroupId=org.codehaus.mojo.archetypes \
   -DarchetypeArtifactId=webapp-javaee6 \
   -DgroupId=net.jalg \
   -DartifactId=mvc \
   -DinteractiveMode=false
</code></pre>

<p>and then added the neccessary repository and dependencies the way he describes. Because JAX-RS 2.0 and Jersey currently undergo some sort of last minute changes I have changed the Jersey dependencies to be on 2.0-SNAPSHOT to get the latest developments.</p>

<p>The templating support I have in mind would let me return any object from a JAX-RS resource method. In addition it would let me annotate the resource method to specify a template to use for constructing the representations. Like so:</p>

<pre><code>@Path("user/{userId}/account")
public class Facade {
    @PathParam("userId") String userId;
 
    @GET
    @Produces("text/html")
    @Path("contract-details")
    @Template("templates/contract.vm")
    public Contract getContractDetails() {
        return new Contract("123456", userId, "new");
    }
}
</code></pre>

<p>The problem here is that the JAX-RS runtime will pick the MessageBodyWriter implementation based on the returned type. It will not, magically, invoke some sort of templating engine. So, how can we trick the runtime into choosing a different MessageBodyWriter? And how can we pass to that not only the returned object but also the path of the desired template?</p>

<p>Here the filter API comes in. We can use the @Template annotation to also act as a binding for a particular filter. This is done with the @NameBinding annotation from the new filter API:</p>

<pre><code>@NameBinding
@Target({ ElementType.TYPE, ElementType.METHOD })
@Retention(value = RetentionPolicy.RUNTIME)
public @interface Template {
  String value() default "";
}
</code></pre>

<p>Now the runtime will invoke all filters annotated with @Template when our getContractDetails() method is called and we can work the magic in a filter.</p>

<p>What happens in the filter below is that we replace the response entity with a wrapper object that holds the template path and the original response entity. The template path we can extract from the annotation, the original response entity we extract from the response context.</p>

<pre><code>@Provider
@Template
public class EntityToModelAndViewWrapper implements ContainerResponseFilter {
 
    @Override
    public void filter(ContainerRequestContext requestContext,
      ContainerResponseContext responseContext) throws IOException {
 
        for (Annotation a : responseContext.getEntityAnnotations()) {
            if (a.annotationType() == Template.class) {
                String templatePath = ((Template) a).value();
                ModelAndView mav = new ModelAndView(responseContext.getEntity(),templatePath);
                responseContext.setEntity(mav,
                   responseContext.getEntityAnnotations(),
                responseContext.getMediaType());
                break;
            }
        }
    }
}
</code></pre>

<p>By changing the type of the response entity, we gain control over the MessageBodyWriter selection. And the runtime will now invoke the MessageBodyWriter we have provided for ModelAndView instances:</p>

<pre><code>@Provider
...
public class ModelToViewMBR implements MessageBodyWriter&lt;ModelAndView&gt; {
  ...
    @Override
    void writeTo(ModelAndView mav, Class&lt;?&gt; arg1, Type arg2,
            Annotation[] arg3, MediaType arg4,
            MultivaluedMap&lt;String, Object&gt; arg5, OutputStream output)
            throws IOException, WebApplicationException {
        Map&lt;String, Object&gt; map = new HashMap&lt;String,Object&gt;();
        map.put("entity", mav.getModel());
        engine.merge(mav.getView(),output,map);
    }
    ...
}
</code></pre>

<p>In the writeTo() method we make the original response entity available to a templating engine under the name ‘entity’ and invoke the merge of template and entity.</p>

<p>The engine member is an instance of a template engine wrapper. You can see the details in the TemplateEngine class in the example source code.</p>

<p>In addition to the response entity it should not be too hard to make available to the template engine all the managed beans of the container runtime’s current session (the request). That way one would have the full power of EJB 3.1 and CDI at one’s disposal.</p>


    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#javaee6-ref">
    		javaee6 <span>3</span>
    	</a></li>
     
    	<li><a href="/categories.html#jax-rs 2.0-ref">
    		jax-rs 2.0 <span>4</span>
    	</a></li>
     
    	<li><a href="/categories.html#jersey 2-ref">
    		jersey 2 <span>2</span>
    	</a></li>
    
  


    </ul>
    

    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2012/09/declarative-cache-control-with-jax-rs-2-0" title="Declarative Cache Control with JAX-RS 2.0">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2012/11/jax-rs-2-0-essential-bookmarks" title="JAX-RS 2.0 Essential Bookmarks">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    
  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2016 Jan Algermissen
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>



<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Using iron to Encapsulate Cookies</title>
    
    <meta name="author" content="Jan Algermissen">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes//bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes//css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Applying the Web To Enterprise IT</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>Using iron to Encapsulate Cookies </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>29 May 2013</span>
    </div>
    <div class="content">
      <p><a href="http://hueniverse.com">Eran Hammer</a> has recently created <a href="https://github.com/hueniverse/iron">iron</a>, a cryptographic procedure and tool to seal arbitrary data in a way so that it cannot be read and also cannot be changed without being noticed.</p>

<p>Besides its intended use in combination with <a href="https://github.com/hueniverse/oz">Oz</a> it can also be used in other scenarios. One of them being encapsulated HTTP cookies. While it is in no way a new thing to pass state to Web clients in encrypted form so they cannot read it or tamper with it, doing it right is relatively hard. Hence, it is great to now have a quasi-standard and sound <a href="https://github.com/hueniverse/iron#introduction">definition</a>.</p>

<p><strong>Update</strong>: Looking something up in <a href="https://twitter.com/postwait">Theo Schlossnagle</a>’s <a href="http://omniti.com/writes/scalable-internet-architectures"><em>Building Scalable Internet Architectures</em></a> I found a passage <em>Addressing Security and Integrity</em> in chapter 7, p.130 that resembles the topic of this post.</p>

<p>To bring iron into the Java world, I have created <a href="https://github.com/algermissen/jiron">jiron</a> and an <a href="https://github.com/algermissen/iron-cookie">example project</a> to illustrate how to use iron for HTTP cookie authentication with encapsulated tokens.</p>

<p>First, let’s see, how to use jiron to seal and unseal data:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import net.jalg.jiron.Jiron;

String data = "Some secret stuff we want protected";

String sealed = Jiron.seal(data, "sealing-password",
                                        Jiron.DEFAULT_ENCRYPTION_OPTIONS,
                                        Jiron.DEFAULT_INTEGRITY_OPTIONS);
   
String unsealed = Jiron.unseal(sealed, "sealing-password",
					Jiron.DEFAULT_ENCRYPTION_OPTIONS,
					Jiron.DEFAULT_INTEGRITY_OPTIONS);
</code></pre>
</div>

<p>The String <code class="highlighter-rouge">sealed</code> is what you can pass around and be sure that nobody can read or modify it, unless in possession of the sealing password.</p>

<p>Suppose you have a Web site that employs cookie-based authentication and suppose you have some data you want to store in that cookie directly so you do not have to go to a database shared by all server instances for looking up that data. For example the user’s login, her real name and information when the cookie expires and re-authentication is enforced.</p>

<p>Initially, a user not in possession of the cookie will be redirected to a login form and the cookie will be issued upon submission of valid credentials. Here is an excerpt of the <a href="https://github.com/algermissen/iron-cookie/blob/master/src/main/java/net/jalg/ironcookie/LoginResource.java">form processing JAX-RS resource</a>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>String data = login + "|" + expires + "|" + realname;
String cookieValue = Jiron.seal(data, ApplicationConfig.ENCRYPTION_KEY,
					Jiron.DEFAULT_ENCRYPTION_OPTIONS,
					Jiron.DEFAULT_INTEGRITY_OPTIONS);

NewCookie c = new NewCookie(AuthFilter.COOKIE_NAME, cookieValue);
return Response.seeOther(redirectUri).cookie(c).build();
</code></pre>
</div>

<p>In the HTTP response the cookie will look something like (line breaks added for clarity):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Set-Cookie:authtoken=Fe26.1**7A6A689DEC9563773B1264CF4CC585CFC9CF84403EE9143650D2EC2EE&lt;br&gt;&lt;/br&gt;24E36A3*k9yW1ZlC5Tr1a5o2Os_QMQ*sxZkQJfHsfyZE_0DI3ugHKdQ3IXwy1jySoz7GrKiTWU*9C58B956A11&lt;br&gt;&lt;/br&gt;81D1F1E3A1A7A1B67D2CF7738B0BFB16C5EB4B381151CAEEC4C6C*3PxSsg5aThLGvU2e8ItXfep-hpMw5x96&lt;br&gt;&lt;/br&gt;L_PbelhnU84;Version=1
</code></pre>
</div>

<p>To protect <a href="https://github.com/algermissen/iron-cookie/blob/master/src/main/java/net/jalg/ironcookie/DashboardResource.java">a resource class</a> by enforcing cookie auth, we bind a JAX-RS 2.0 filter to that class using a new <a href="https://github.com/algermissen/iron-cookie/blob/master/src/main/java/net/jalg/ironcookie/TokenAuthProtected.java">annotation</a>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//...
@TokenAuthProtected
public String getDashboard(@Context SecurityContext sc) { ... }
</code></pre>
</div>

<p>The <a href="https://github.com/algermissen/iron-cookie/blob/master/src/main/java/net/jalg/ironcookie/AuthFilter.java">auth enforcing filter class</a> extracts the cookie, checks expiration time and puts the data contained in the cookie in a place where it can be accessed by the resource class.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Cookie cookie = context.getCookies().get(COOKIE_NAME);
// Redirect to form if no cookie
String data = Jiron.unseal(cookie.getValue(), ApplicationConfig.ENCRYPTION_KEY,
					Jiron.DEFAULT_ENCRYPTION_OPTIONS,
					Jiron.DEFAULT_INTEGRITY_OPTIONS);
// ...
String[] fields = data.split("\\|");
final String username = fields[0];
final long expires = Long.parseLong(fields[1]);
final String realname = fields[2];
// ...
if (now &gt; expires) {
  context.abortWith(Response.temporaryRedirect(loginFormUri).build());
  return;
}

context.setSecurityContext(new TokenSecurityContext(username, realname));
</code></pre>
</div>

<p>Using the security context and a custom Principal, the resource class is provided access to the user’s login and realname.</p>

<p>(There is currently discussion in the JAX-RS 2 expert group to enable passing information from filters to resource classes using properties on the filter chain. That would be the better solution than the SecurityContext/Principal ‘hack’).</p>

<p>Please have a look at the source code for the code details.</p>


    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#HTTP Auth-ref">
    		HTTP Auth <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#JAX-RS 2.0-ref">
    		JAX-RS 2.0 <span>4</span>
    	</a></li>
    
  


    </ul>
    

    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2013/05/beyond-oauth" title="Beyond OAuth">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next disabled"><a>Next &rarr;</a>
      
      </ul>
    </div>
    <hr>
    
  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2017 Jan Algermissen
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

